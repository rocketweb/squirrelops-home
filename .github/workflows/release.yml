name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Build & push multi-arch Docker image to GHCR
  # ---------------------------------------------------------------------------
  build-docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/squirrelops-sensor
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: sensor
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Job 2: Build macOS .pkg installer
  # ---------------------------------------------------------------------------
  build-macos-pkg:
    name: Build macOS .pkg
    runs-on: macos-15
    env:
      HAS_CERTS: ${{ secrets.APPLE_CERTIFICATE_P12 != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Import signing certificates
        if: ${{ env.HAS_CERTS == 'true' }}
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          # Allow codesign to use the keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

          # Clean up cert file
          rm -f "$CERT_PATH"

      - name: Select Xcode 16.2
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Strip version prefix
        id: version
        run: echo "clean=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build .pkg
        env:
          SQUIRRELOPS_VERSION: ${{ steps.version.outputs.clean }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: bash scripts/build-pkg.sh

      - name: Upload .pkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg
          path: build/pkg/output/SquirrelOpsHome-*
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # Job 3: Publish sensor wheel to PyPI
  # ---------------------------------------------------------------------------
  publish-sensor-wheel:
    name: Publish Sensor Wheel to PyPI
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tooling
        run: pip install build

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          sed -i "s/^version = .*/version = \"${VERSION}\"/" sensor/pyproject.toml

      - name: Build wheel
        run: python -m build sensor/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: sensor/dist/

  # ---------------------------------------------------------------------------
  # Job 4: Create GitHub Release and update manifest
  # ---------------------------------------------------------------------------
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-docker, build-macos-pkg]
    steps:
      - uses: actions/checkout@v4

      - name: Download .pkg artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-pkg
          path: release-assets/

      - name: Prepare release body
        id: body
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${TAG_NAME#v}"
          cat > release-body.md << 'RELEASE_EOF'
          ## Install

          ### macOS (recommended)

          **[Download SquirrelOpsHome-VERSION.pkg](PLACEHOLDER)** and double-click to install.

          The installer sets up everything — the app and the network sensor — in one step. No terminal required.

          After installing, open **SquirrelOps Home** from your Applications folder and follow the on-screen pairing flow.

          ### Linux / NAS (Docker)

          ```bash
          curl -fsSL https://get.squirrelops.io/install.sh | sudo bash
          ```

          Then install the macOS app separately to use as your dashboard.

          ### Uninstall

          ```bash
          sudo bash /Library/SquirrelOps/uninstall.sh
          ```

          ---
          RELEASE_EOF

          # Fix version placeholder
          sed -i "s/VERSION/${VERSION}/g" release-body.md

          # Fix download URL
          PKG_FILE=$(ls release-assets/SquirrelOpsHome-*.pkg 2>/dev/null | grep -v '.sha256' | head -1)
          PKG_BASENAME=$(basename "$PKG_FILE")
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${PKG_BASENAME}"
          sed -i "s|PLACEHOLDER|${DOWNLOAD_URL}|g" release-body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-body.md
          files: |
            release-assets/SquirrelOpsHome-*.pkg
            release-assets/SquirrelOpsHome-*.pkg.sha256

      - name: Update manifest.json
        env:
          TAG_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          VERSION="${TAG_NAME#v}"
          PKG_FILE=$(ls release-assets/SquirrelOpsHome-*.pkg 2>/dev/null | grep -v '.sha256' | head -1)
          PKG_SHA256=""
          if [ -f "${PKG_FILE}.sha256" ]; then
            PKG_SHA256=$(awk '{print $1}' "${PKG_FILE}.sha256")
          fi

          DOWNLOAD_BASE="https://github.com/${REPO}/releases/download/${TAG_NAME}"
          PKG_BASENAME=$(basename "$PKG_FILE")

          # Update manifest using jq
          jq \
            --arg version "$VERSION" \
            --arg pkg_url "${DOWNLOAD_BASE}/${PKG_BASENAME}" \
            --arg pkg_sha "${PKG_SHA256}" \
            --arg release_url "https://github.com/${REPO}/releases/tag/${TAG_NAME}" \
            '.sensor.latest_version = $version |
             .app.latest_version = $version |
             .app.download_url = $pkg_url |
             .app.release_notes_url = $release_url |
             .sensor.release_notes_url = $release_url |
             .app.sha256 = $pkg_sha' \
            site/public/manifest.json > site/public/manifest.json.tmp

          mv site/public/manifest.json.tmp site/public/manifest.json

          echo "Updated manifest.json:"
          cat site/public/manifest.json

      - name: Commit and push manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add site/public/manifest.json
          git commit -m "chore: update manifest.json for ${GITHUB_REF_NAME}"
          git push origin HEAD:main
